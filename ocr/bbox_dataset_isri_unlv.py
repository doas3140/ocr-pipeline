# AUTOGENERATED! DO NOT EDIT! File to edit: nbs/66_bbox_dataset_isri_unlv.ipynb (unless otherwise specified).

__all__ = ['isri_unlv_config', 'cat2id', 'get_doc2paths', 'read', 'read_lines', 'get_img_filenames',
           'get_filename2bboxes_dict', 'create_df']

# Cell
from .core import save_dict, read_dict, plot
from fastai import *
from fastai.vision import *
import pandas as pd
import numpy as np
import cv2
from tqdm.notebook import tqdm
from pathlib import PosixPath

# Cell
cat2id = {
'Background': 0,
'Attent_line': 1,
'Other_Text': 2,
'cc': 3,
'Company_Sig': 4,
'Subject': 5,
'Enclosure': 6,
'Sign/Type': 7,
'Inside_Addr': 8,
'Dateline': 9,
'Footnote': 10,
'Closing': 10,
'Salutat': 11,
'Signer': 12,
'Letterhead': 13,
'Table': 14,
'Caption': 15,
'Header/Footer': 16,
'Text': 17
}

class isri_unlv_config:
    MAIN_DIR = PosixPath('../data/isri_unlv/')
    FILE_DIR = PosixPath('../data/bbox/isri_unlv_bbox.pickle')
    cat2id = cat2id

# Cell
read = lambda fp: open(fp).read()
read_lines = lambda fp: open(fp).readlines()

def get_doc2paths():
    cat_freq = defaultdict(lambda: 0)
    doc2paths = defaultdict(lambda: {'img': None, 'txt': None, 'uzn': None})
    for fp in isri_unlv_config.MAIN_DIR.iterdir():
        if str(fp)[-1] == 'B' or str(fp)[-1] == 'A':
            document_category = str(fp).split('/')[-1]
            for subfp in fp.iterdir():
                if os.path.isdir(subfp):
                    page_id = str(subfp).split('/')[-1]
                    for i,fpath in enumerate(subfp.iterdir()):
                        doc_name = str(fpath).split('/')[-1][:-4]
                        fn = 'isri_unlv_{}_{}'.format(document_category, page_id, i)
                        if str(fpath)[-4:] == '.tif':
                            doc2paths[doc_name]['img'] = fpath

                        if str(fpath)[-4:] == '.txt':
                            doc2paths[doc_name]['txt'] = fpath

                        if str(fpath)[-4:] == '.uzn':
                            doc2paths[doc_name]['uzn'] = fpath
    doc2paths = dict(doc2paths)
    del doc2paths['total']
    return doc2paths

# Cell
def get_img_filenames():
    doc2paths = get_doc2paths()
    return [str(doc2paths[name]['img']) for name in doc2paths]
    for i, name in enumerate(doc2paths.keys()):
        img_path = str(doc2paths[name]['img'])


# Cell
def get_filename2bboxes_dict():
    return read_dict(isri_unlv_config.FILE_DIR)

# Cell
def create_df():
    filenames = get_img_filenames()
    data = []
    for i, path in enumerate(filenames):
        valid = i < len(filenames)*0.3
        data.append((path, valid, 'isri_unlv'))
    return pd.DataFrame(data, columns=['image_path', 'valid', 'dataset'])